<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Memory क्रीडा</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@sanskrit-coders/sanscript@1.1.0/sanscript.min.js"></script>
  <link href="css/mmk.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
</head>

<body>
  <center>
    <font size="+18" color=blue> Memory क्रीडा </font>

    <br>
    <p id="wm">Matches Done: <span id=nomd style="color: green; font-size: 20px;">०</span> Wrong Moves: <span
        style="color: red; font-size: 20px;" id=nowt>०</span> </p>
    <progress id=pr max=15 value=0></progress>
    <div id="mytable">
    </div>
  </center>
  <script>
    var secs = 0;
    function countSecs(elem) {
      //console.log(secs);
      //var element = document.getElementById(elem);
      //element.innerHTML = "Time: " + Sanscript.t(String(secs),'iast', 'devanagari') + " seconds";
      secs++;

    }
    // end of timer code
    document.addEventListener('DOMContentLoaded', function () {
      var lnk = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6CFR_0gDsZl-lmwLFWmtdXMXYGVEHGJ8fvBu2_5wvbEl9L-4Yr0ugI0TFTTdvtLlMTRmLnCIJ5FBF/pub?gid=0&single=true&output=csv";
      Papa.parse(lnk, {
        download: true,
        header: true,
        complete: populateWlist
      })
    })
    function populateWlist(fildat) {
      var wpp = 15; // words per page
      document.getElementById("pr").max = wpp;
      var tlang = [];
      tlang[1] = "itrans";
      tlang['gu'] = "gujarati";
      tlang['ka'] = "kannada";
      tlang['be'] = "bengali";
      tlang['ml'] = "malayalam";
      tlang['te'] = "telugu";
      tlang['ta'] = "tamil";
      fullist = fildat.data;

      var openmojibase = "https://openmoji.org/data/color/svg/";
      var numberOfWrongTries = 0;
      matchesdone = 0;
      var timer;
      triesElement = document.getElementById("nowt");
      const urlParams = new URLSearchParams(window.location.search);
      var o = urlParams.get('o');
      if (!o) // open mode - 1 is true - not flipped
        o = 0;
      var set = urlParams.get('s');
      if (!set || isNaN(set) || (set >= fullist.length))
        set = 0;

      var image = [];
      var words = [];
      var imglnk = "";
      for (i = 0; i < wpp; i++) {
        words.push(fullist[(set * wpp) + i].padam);
        if (fullist[(set * wpp) + i]["Imaage link"].length == 4 || fullist[(set * wpp) + i]["Imaage link"].length == 5)
          imglnk = openmojibase + fullist[(set * wpp) + i]["Imaage link"] + ".svg";
        else
          imglnk = fullist[(set * wpp) + i]["Imaage link"];
        image.push(imglnk)
      }
      while (!words[words.length - 1]) {
        words.pop();
      }
      while (!image[image.length - 1]) {
        image.pop();
      }
      //mmk-start
      var colors = ['tomato', 'aqua', 'blue', 'fuchsia', 'gray', 'green', 'lime', 'maroon', 'navy', 'olive', 'purple ', 'red', 'silver', 'teal', 'yellow']

      var l = urlParams.get('l'); // learn mode - 1 is true
      if (!l)
        l = 0;
      var t = urlParams.get('t'); // transliterate mode - 1 is true
      if (!t)
        t = 0;
      if (l == 1) {
        document.getElementById("ss").style.display = "inline-block";
        document.getElementById("pr").style.display = "none";
        document.getElementById("wm").style.display = "none";
      }

      function restart() {
        location.reload();
      }


      var rowLength = 5;
      rowLength = words.length / 3;
      var colLength = 6;//prompt("Please enter number of columns (must not exceed 6) \n NOTE THAT : the multiplier of row and columns must be even number for the game to work");
      var gamesize = rowLength * colLength;
      var height = 570 / rowLength;
      var width = 900 / colLength;
      width = document.documentElement.offsetWidth / 6; //8;
      height = document.documentElement.offsetHeight / 2; //3;
      width = 150;
      height = 120;
      if (l != 1)
        timer = setInterval('countSecs("timer")', 1000); //1000ms to wait before executing the code =1 second  
      countSecs("timer");

      function code() {

        var temp = []
        var waiting = { value: false };

        var D1Data = [];          // D1Data has duplicated image objects.
        var D2Data = [];
        var count = 0;
        for (var x = 0; x < gamesize / 2; x++) {
          D1Data.push({ src: image[x], clicked: false });
          D1Data.push({ src: image[x], clicked: false, wrd: words[x] });
        }

        for (var x = 0; x < D1Data.length; x++) {
          //console.log('index: ' + x + ' ' + D1Data[x].src)
        }
        var rand = 0;
        // fill D2Data 2D array. (2D array is a group 1D arrays)
        for (var y = 0; y < rowLength; y++) {
          var temp = [];
          var x = 0;

          while (x < colLength) {
            if (l != 1) {
              rand = Math.floor(Math.random() * D1Data.length);

              temp.push(D1Data[rand]);
              temp[x].y = x;
              temp[x].x = y;
              D1Data.splice(rand, 1)
            }
            else {

              temp.push(D1Data[rand]);
              rand += 1;
            }
            //console.log('iteration: ' + y +' removed at index: ' + rand);

            x++;
          }
          D2Data.push(temp);

        }

        // functions and variables
        var faceUp = 0;
        var clickedCards = [];
        var bg = 'bp26e.png'

        function genTable(rowLength, colLength, imageData2D) {

          var table = document.createElement("TABLE");
          table.id = 'tbl';
          var myTableDiv = document.getElementById("mytable");

          for (var i = 0; i < rowLength; i++) {
            var tr = document.createElement("TR");
            table.appendChild(tr);
            for (var j = 0; j < colLength; j++) {
              var td = document.createElement("TD");
              tr.appendChild(td);
              if (!imageData2D[i][j].wrd) {
                var img = document.createElement("img");
                if (o != 1)
                  img.src = 'bp26e.png';
                else
                  img.src = imageData2D[i][j].src;
                img.height = height;
                img.width = width;
                td.appendChild(img);
              }
              else {
                var p = document.createElement("p");

                p.className = "myp";
                p.innerHTML = imageData2D[i][j].wrd;
                if (t != 0 && tlang[t])
                  p.innerHTML += " - " + Sanscript.t(imageData2D[i][j].wrd, 'devanagari', tlang[t]);
                td.appendChild(p);
              }
            }
          }
          myTableDiv.appendChild(table);
        }

        genTable(rowLength, colLength, D2Data); // generate table..

        var clkfn = function () {    // THE ONCLICK EVENT FOR ALL IMAGES.

          var row = this.parentElement.parentElement.rowIndex;
          var column = this.parentElement.cellIndex;
          if (!D2Data[row][column].clicked && !waiting.value) {
            if (clickedCards.length == 0) {            // if it is the only card, add it to clickedCards, set clicked to true, set background
              this.src = D2Data[row][column].src;
              this.height = height;
              this.width = width;
              D2Data[row][column].clicked = true;
              clickedCards.push(D2Data[row][column]);
              d = document.getElementsByTagName("tr")[clickedCards[0].x];
              r = d.getElementsByTagName("td")[clickedCards[0].y];
              r.style.border = "2px dashed red";
            }
            else {        // compare card to one in the list..
              //console.log('comparing to one in the lisst')
              if (D2Data[row][column].src === clickedCards[0].src) {    // if it matches..
                d = document.getElementsByTagName("tr")[clickedCards[0].x];
                r = d.getElementsByTagName("td")[clickedCards[0].y];
                r.style.border = "3px solid " + colors[matchesdone]; //blue";
                r.style.cursor = "no-drop";
                r.style.color = "blue";
                //r.innerHTML+="✔️";
                matchesdone++;
                r.innerHTML += "<br>☑️ " + Sanscript.t(String(matchesdone), 'iast', 'devanagari')
                document.getElementById("pr").value = matchesdone;
                //console.log('match')
                document.getElementById("nomd").innerHTML = Sanscript.t(String(matchesdone), 'iast', 'devanagari');
                this.parentElement.style.border = "3px solid " + colors[matchesdone - 1]; //blue";
                this.parentElement.style.cursor = "no-drop";
                this.style.color = "blue";
                //this.innerHTML+="✔️";
                this.innerHTML += "<br>✔️ " + Sanscript.t(String(matchesdone), 'iast', 'devanagari')
                this.src = D2Data[row][column].src
                D2Data[row][column].clicked = true;
                clickedCards = [];  // empty the matrix.
                count += 2;
                //console.log(count);
                if (count == gamesize) {
                  window.alert("उत्तमम् ! You matched all " + Sanscript.t(String(wpp), 'iast', 'devanagari') + " in " + Sanscript.t(String(secs), 'iast', 'devanagari') + " seconds while making " + Sanscript.t(String(numberOfWrongTries), 'iast', 'devanagari') + " wrong moves");
                  clearTimeout(timer); //stop timer function
                  var ask = confirm("पुनः ? Press 'ok' to play again");
                  if (ask) {
                    restart();
                  }
                }
              }
              else {             // not a match.
                numberOfWrongTries += 1;
                triesElement.innerHTML = Sanscript.t(String(numberOfWrongTries), 'iast', 'devanagari');
                //this.src = bg;
                this.src = D2Data[row][column].src; // show picture of card u just clicked
                D2Data[row][column].clicked = true; // new
                waiting.value = true; //
                d = document.getElementsByTagName("tr")[clickedCards[0].x];
                r = d.getElementsByTagName("td")[clickedCards[0].y];
                r.style.border = "1px solid blue";
                setTimeout(flipback, 700, row, column, this, clickedCards, waiting, D2Data)
              }
            }
          }
        };
        if (l != 1) {
          var list = document.getElementsByTagName("img");
          for (var i = 0; i < list.length; i++) {
            list[i].onclick = clkfn;
          }
          var plist = document.getElementsByClassName("myp");
          for (var i = 0; i < plist.length; i++) {
            plist[i].onclick = clkfn;
          }
        }
        function flipback(row, column, This, clickedCards, waiting, D2Data) {  // flip both cards back to facedown
          This.src = bg;   // flip this to bg
          document.getElementById('tbl').rows[clickedCards[0].x].cells[clickedCards[0].y].firstElementChild.src = bg;   // flip the one in clickedCards
          // clicked is false in both.
          clickedCards[0].clicked = false;
          D2Data[row][column].clicked = false;
          waiting.value = false;
          clickedCards.splice(0, 1);
        }
      }
      code();
      //mmk-end
    }
  </script>
</body>
</html>