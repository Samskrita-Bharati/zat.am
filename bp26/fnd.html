<!DOCTYPE HTML>
<html>

<head>
  <head>
    <title>‡§Ö‡§®‡•ç‡§µ‡•á‡§∑‡§£‡§Æ‡•ç</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@sanskrit-coders/sanscript@1.1.0/sanscript.min.js"></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/papaparse@latest/papaparse.min.js"
    ></script>
    <link rel="stylesheet" href="./css/fndstyle.css" />
    <!-- Header CSS -->
    <link rel="stylesheet" href="./css/header.css" />
    <style>
      /* ‚úÖ Celebration UI (inline, no external JS) */
      #bp26CelebrateOverlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.35);
        z-index: 10000;
        padding: 20px;
      }

      .bp26CelebrateBox {
        position: relative;
        width: min(460px, 92vw);
        background: #fff;
        border-radius: 18px;
        padding: 18px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
        text-align: center;
        font-family: system-ui, Arial, sans-serif;
      }

      .bp26Sparkles {
        font-size: 54px;
        line-height: 1.1;
        margin: 8px 0 6px;
        animation: bp26Pop 600ms ease-out both;
      }

      @keyframes bp26Pop {
        0% {
          transform: scale(0.6);
          opacity: 0;
        }

        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .bp26Btn {
        margin-top: 12px;
        padding: 10px 14px;
        border-radius: 12px;
        border: 1px solid #ddd;
        background: #f9fafb;
        cursor: pointer;
      }

      .bp26Confetti {
        position: fixed;
        top: -12px;
        width: 10px;
        height: 10px;
        border-radius: 3px;
        z-index: 10001;
        opacity: .95;
        animation: bp26Fall 950ms linear forwards;
        pointer-events: none;
      }

      @keyframes bp26Fall {
        to {
          transform: translateY(110vh) rotate(540deg);
          opacity: 0.9;
        }
      }

      @media print {
        .k {
          border-left: 4px ridge green;
        }

        .p {
          border-left: 3px groove blue;
        }

        .s {
          border-left: 3px groove red;
        }

        .n {
          border-left: 3px groove black;
        }

        button {
          display: none !important;
        }
      }
    </style>
  </head>

<body>
  <script type="module" src="/auth/api/middleware.js"></script>
  <!-- Header Placeholder -->
  <div id="header-placeholder"></div>
  <script type="module" src="../js/bilingual-toggle.js"></script>
  <!-- Load Header -->
  <script src="js/load-header.js"></script>
  <style>
    body {
      padding-top: 7%;
    }
  </style>
  <center>
    <h3>Find <span style="position:relative;color:tomato;z-index:99" id="tofind"></span> ... ‚ùå = <span id="wt">‡•¶</span>
    </h3>
  </center>
  <div id="svgdiv">
  </div>
  <p></p>

  <!-- ‚úÖ Celebration overlay (inline) -->
  <div id="bp26CelebrateOverlay">
    <div class="bp26CelebrateBox">
      <div class="bp26Sparkles">‚ú®üéâ‚ú®</div>
      <div id="bp26CelebrateTitle" style="font-weight:700;font-size:18px;margin-bottom:6px;">
        Submitted ‚úÖ
      </div>
      <div id="bp26CelebrateSub" style="font-size:14px;color:#374151;">
        Nice work!
      </div>
      <button id="bp26CelebrateClose" class="bp26Btn">Close</button>
    </div>
  </div>

</body>

<script>
    /* ---------------------------
       Celebration (inline)
    --------------------------- */
    function bp26Celebrate({ title="Submitted ‚úÖ", subtitle="Nice work!", score=null } = {}) {
      const overlay = document.getElementById("bp26CelebrateOverlay");
      const t = document.getElementById("bp26CelebrateTitle");
      const s = document.getElementById("bp26CelebrateSub");

      t.textContent = title;
      s.textContent = score === null ? subtitle : `${subtitle}  Score: ${score} ‚ú®`;

      overlay.style.display = "flex";
      bp26BurstConfetti(70);

      setTimeout(() => { overlay.style.display = "none"; }, 3000);
    }

    function bp26BurstConfetti(count=60) {
      for (let i = 0; i < count; i++) {
        const c = document.createElement("div");
        c.className = "bp26Confetti";
        c.style.left = Math.random() * 100 + "vw";
        c.style.width = (6 + Math.random() * 8) + "px";
        c.style.height = (6 + Math.random() * 8) + "px";
        c.style.background = `hsl(${Math.floor(Math.random() * 360)}, 90%, 60%)`;
        c.style.transform = `translateY(0) rotate(${Math.random() * 180}deg)`;
        c.style.animationDuration = (800 + Math.random() * 600) + "ms";
        document.body.appendChild(c);
        setTimeout(() => c.remove(), 6000);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const closeBtn = document.getElementById("bp26CelebrateClose");
      const overlay = document.getElementById("bp26CelebrateOverlay");
      if (closeBtn) closeBtn.addEventListener("click", () => overlay.style.display = "none");
      if (overlay) overlay.addEventListener("click", (e) => {
        if (e.target === overlay) overlay.style.display = "none";
      });
    });
  </script>

<script>
  const BP26_GAME_ID = "bp26-Game3";
  const BP26_DAY_NUM = 5;

  var secs = 0;
  function countSecs(elem) {
    secs++;
  }

  var wpp = 15; // words per page

  var tlang = [];
  tlang[1] = "itrans";
  tlang['gu'] = "gujarati";
  tlang['ka'] = "kannada";
  tlang['be'] = "bengali";
  tlang['ml'] = "malayalam";
  tlang['te'] = "telugu";
  tlang['ta'] = "tamil";

  const urlParams = new URLSearchParams(window.location.search);
  var t = urlParams.get("t");
  // Default: no transliteration when `t` is missing.
  // When bilingual mode is ON, `t` will be set by the
  // main menu / toggle (e.g., t=gu, t=ka, etc.).
  if (!t) t = 0;
  var set = urlParams.get("s");
  if (!set || isNaN(set)) set = 0;
  var tofind = parseInt((Math.random() * 100) % wpp);
  var wt = 1;

  let gameFinished = false;

  // higher is better. Uses: time + wrong attempts
  // wrongAttempts = (attempts - 1)
  function computeScore(attempts, seconds) {
    const wrongAttempts = Math.max(0, attempts - 1);
    // 100 is the initialized score, penalties reduce it from there
    const score = 100 - (wrongAttempts * 5) - Math.floor(seconds / 2);
    return Math.max(0, Math.floor(score));
  }

  // submitting to firebase
  async function submitScoreNow(finalScore) {
    console.log("[BP26] submitScoreNow()", {
      game: BP26_GAME_ID,
      day: BP26_DAY_NUM,
      finalScore
    });

    if (typeof window.reportScore !== "function") {
      console.warn("[BP26] reportScore() not found. Check that ./js/bp26-score.js is loading.");
      return;
    }

    try {
      await window.reportScore(finalScore);
      console.log("[BP26] ‚úÖ reportScore success");
    } catch (err) {
      console.error("[BP26] ‚ùå reportScore failed", err);
    }
  }

  var chk = async function (id) {
    if (gameFinished) return;

    if (id == tofind) {
      document.getElementById(id).style["background"] = "green";
      document.getElementById(id).style["border"] = "1px solid green";

      // compute score at win-time
      // wt is attempt counter(starts at 1, increments each try)
      const attempts = wt; // attempts taken
      const finalScore = computeScore(attempts, secs);

      console.log("[BP26] WIN", { attempts, secs, finalScore });

      gameFinished = true;
      // always submit when finished
      await submitScoreNow(finalScore);

      // ‚úÖ celebration (user WILL see it)
        bp26Celebrate({
          title: "Game Finished ‚úÖ",
          subtitle: `Great job! `,
          score: finalScore
        });
    }
    else {
      document.getElementById(id).style["background"] = "pink";
      document.getElementById(id).style["border"] = "1px dotted red";
      $("#wt").html(Sanscript.t(String(wt++), 'itrans', 'devanagari'));
    }
  }

  document.addEventListener('DOMContentLoaded', function () {

    // prompt name + set game/day
    // This must happen as the game starts.
    if (typeof window.bp26Init === "function") {
      window.bp26Init({ game: BP26_GAME_ID, day: BP26_DAY_NUM });
      console.log("[BP26] bp26Init called", { game: BP26_GAME_ID, day: BP26_DAY_NUM });
    } else {
      console.warn("[BP26] bp26Init not found yet (bp26-score.js might not be loaded yet).");
    }

    timer = setInterval('countSecs("timer")', 1000);
    countSecs("timer");

    var lnk = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6CFR_0gDsZl-lmwLFWmtdXMXYGVEHGJ8fvBu2_5wvbEl9L-4Yr0ugI0TFTTdvtLlMTRmLnCIJ5FBF/pub?gid=0&single=true&output=csv";
    Papa.parse(lnk, {
      download: true,
      header: true,
      complete: populateWlist
    })
  })

  function populateWlist(fildat) {
    fullist = fildat.data;
    if (set > fildat.data.length / wpp) set = 0;

    var openmojibase = "https://openmoji.org/data/color/svg/";
    var image = [];
    var words = [];
    var aud = [];
    var imglnk = "";

    for (i = 0; i < wpp; i++) {
      words.push(fullist[(set * wpp) + i].padam);

      if (fullist[(set * wpp) + i]["Imaage link"].length == 4 || fullist[(set * wpp) + i]["Imaage link"].length == 5)
        imglnk = openmojibase + fullist[(set * wpp) + i]["Imaage link"] + ".svg";
      else
        imglnk = fullist[(set * wpp) + i]["Imaage link"];

      image.push(imglnk);
      aud.push(fullist[(set * wpp) + i]["alnk"]);
    }

    console.log("[BP26] Loaded set", { set, tofind, word: words[tofind], audio: aud[tofind] });

    $("#tofind").html("<button id=" + tofind + " onclick='musicelements[this.id].play()';>üîä</button> " + words[tofind]);

    if (t != 0 && tlang[t])
      $("#tofind").append(" = " + Sanscript.t(words[tofind], 'devanagari', tlang[t]));

    $.each(words, function (i, v) {
      imglnk = image[i];
      alnk = aud[i];

      var img = '';
      positiontop = (Math.random() * (window.visualViewport.height - 121)) + 30;
      positionright = Math.random() * (window.visualViewport.width - 121);
      zindex = i;

      img += '<img id="' + i + '" src="' + imglnk +
        '" style="top: ' + positiontop + 'px;' +
        'right: ' + positionright + 'px;' +
        'z-index: ' + zindex +
        ';" width="121" onclick="chk(this.id)">';

      document.getElementById('svgdiv').innerHTML += img +
        "<audio id=" + i + " src=" + alnk + " preload='auto'></audio>";
    });

    musicelements = document.getElementsByTagName("audio");

    // autoplay target audio once
    try {
      musicelements[tofind].play();
    } catch (e) {
      console.warn("[BP26] autoplay blocked", e);
    }
  }
</script>

<script type="module" src="./js/bp26-score.js"></script>


</html>
