<!DOCTYPE html>
<html lang="en">
<head>
  <!-- NOTE THIS DOES NOT WORK WITH .htm ONLY .html -->
  <meta charset="utf-8" />
  <title>Audio Match â€“ Learn Words</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script type="text/javascript" src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@sanskrit-coders/sanscript@1.1.0/sanscript.min.js"></script>
  <link rel="stylesheet" href="./css/mastyle.css" />
  <!-- Header CSS -->
  <link rel="stylesheet" href="css/header.css" />

  <style>
    /* body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f7f9fc; }
    header { padding:1rem; background:white; border-bottom:1px solid #ddd; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { padding:8px 14px; border-radius:8px; border:1px solid #ccc; cursor:pointer; }
    .accent { background:#16a34a; color:white; }
    .warn { background:#dc2626; color:white; }
    main { max-width:1100px; margin:auto; padding:1rem; }
    .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .card { background:white; border-radius:10px; padding:12px; display:flex; align-items:center; gap:10px; }
    .play { border-radius:50%; width:42px; height:42px; }
    .dropzone { flex:1; border:2px dashed #ccc; padding:10px; border-radius:8px; min-height:28px; }
    .correct { border-color:#16a34a; }
    .incorrect { border-color:#dc2626; }
    .tiles { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .tile { background:#edf2f7; padding:6px 10px; border-radius:8px; border:1px solid #ccc; cursor:grab; user-select:none; }
     */
    /* âœ… Celebration UI (inline - no external file) */
    #bp26CelebrateOverlay{
      position: fixed; inset: 0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.35);
      z-index: 10000;
      padding: 20px;
    }
    .bp26CelebrateBox{
      position: relative;
      width: min(460px, 92vw);
      background: #fff;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.25);
      text-align: center;
      font-family: system-ui, Arial, sans-serif;
    }
    .bp26Sparkles{
      font-size: 54px;
      line-height: 1.1;
      margin: 8px 0 6px;
      animation: bp26Pop 600ms ease-out both;
    }
    @keyframes bp26Pop{
      0%{ transform: scale(0.6); opacity: 0; }
      100%{ transform: scale(1); opacity: 1; }
    }
    .bp26Btn{
      margin-top: 12px; padding: 10px 14px;
      border-radius: 12px; border: 1px solid #ddd;
      background: #f9fafb; cursor: pointer;
    }
    .bp26Confetti{
      position: fixed;
      top: -12px;
      width: 10px; height: 10px;
      border-radius: 3px;
      z-index: 10001;
      opacity: .95;
      animation: bp26Fall 950ms linear forwards;
      pointer-events: none;
    }
    @keyframes bp26Fall{
      to{ transform: translateY(110vh) rotate(540deg); opacity: 0.9; }
    }
  </style>
</head>
<body>
  <!-- Header Placeholder -->
  <div id="header-placeholder"></div>
  <script type="module" src="../js/bilingual-toggle.js"></script>
  <!-- Load Header -->
  <script src="js/load-header.js"></script>
  <style>
    body {
      padding-top: 7%;
    }
  </style>
  <header>
    <h1 id="appTitle">Audio Match (wip)</h1>
  </header>

<main>
  <div class="controls" role="group" aria-label="Controls">
    <button id="checkBtn" class="accent">Check Answers</button>
    <button id="resetBtn" class="warn">Reset</button>
    <button id="playAllBtn" title="Play all sounds in order">
      Play All â–¶
    </button>
  </div>
  <p class="hint" id="headingHint">
    Drag or click a word from the bank onto the matching sound card. On
    touch devices, tap a word, then tap a card.
  </p>

  <section class="grid" id="cards" aria-label="Sound cards">ff</section>

  <section class="wordbank" aria-label="Word bank">
        <h2 style="margin: 5px">Word Bank</h2>
        <div class="tiles" id="tiles"></div>
        <div class="status" aria-live="polite">
          <div id="statusText">Ready.</div>
          <div class="score">
            Score: <span id="score">0</span>/<span id="total">0</span>
          </div>
        </div>
      </section>
</main>

<!-- âœ… Celebration overlay (inline) -->
<div id="bp26CelebrateOverlay">
  <div class="bp26CelebrateBox">
    <div class="bp26Sparkles">âœ¨ðŸŽ‰âœ¨</div>
    <div id="bp26CelebrateTitle" style="font-weight:700;font-size:18px;margin-bottom:6px;">
      Submitted âœ…
    </div>
    <div id="bp26CelebrateSub" style="font-size:14px;color:#374151;">
      Nice work!
    </div>
    <button id="bp26CelebrateClose" class="bp26Btn">Close</button>
  </div>
</div>

<script>
  /* -------------------------------
     Celebration (inline)
  -------------------------------- */
  function bp26Celebrate({ title="Submitted âœ…", subtitle="Nice work!", score=null } = {}) {
    const overlay = document.getElementById("bp26CelebrateOverlay");
    const t = document.getElementById("bp26CelebrateTitle");
    const s = document.getElementById("bp26CelebrateSub");

    t.textContent = title;
    s.textContent = score === null ? subtitle : `${subtitle}  Score: ${score} âœ¨`;

    overlay.style.display = "flex";
    bp26BurstConfetti(70);

    setTimeout(() => { overlay.style.display = "none"; }, 2200);
  }

  function bp26BurstConfetti(count=60) {
    for (let i = 0; i < count; i++) {
      const c = document.createElement("div");
      c.className = "bp26Confetti";
      c.style.left = Math.random() * 100 + "vw";
      c.style.width = (6 + Math.random() * 8) + "px";
      c.style.height = (6 + Math.random() * 8) + "px";
      c.style.background = `hsl(${Math.floor(Math.random() * 360)}, 90%, 60%)`;
      c.style.transform = `translateY(0) rotate(${Math.random() * 180}deg)`;
      c.style.animationDuration = (800 + Math.random() * 600) + "ms";
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 1600);
    }
  }

  // close handlers
  document.getElementById("bp26CelebrateClose").addEventListener("click", () => {
    document.getElementById("bp26CelebrateOverlay").style.display = "none";
  });
  document.getElementById("bp26CelebrateOverlay").addEventListener("click", (e) => {
    if (e.target.id === "bp26CelebrateOverlay") e.target.style.display = "none";
  });

  /* -------------------------------
     Game logic
  -------------------------------- */
  const urlParams = new URLSearchParams(window.location.search);
      var t = urlParams.get("t");
      if (!t)
        // open mode - 1 is true - not flipped
        t = 0;
      var tlang = [];
      tlang[1] = "itrans";
      tlang["gu"] = "gujarati";
      tlang["ka"] = "kannada";
      tlang["be"] = "bengali";
      tlang["ml"] = "malayalam";
      tlang["te"] = "telugu";
      tlang["ta"] = "tamil";
      const state = {
        items: [],
        assigned: new Map(), // dropzoneId -> itemId (word)
        selectedTileId: null, // touch/keyboard selection
        lastCheck: null,
      };

      const els = {
        appTitle: document.getElementById("appTitle"),
        cards: document.getElementById("cards"),
        tiles: document.getElementById("tiles"),

        checkBtn: document.getElementById("checkBtn"),
        resetBtn: document.getElementById("resetBtn"),
        playAllBtn: document.getElementById("playAllBtn"),

        statusText: document.getElementById("statusText"),
        score: document.getElementById("score"),
        total: document.getElementById("total"),
      };

      // --- Utilities ---
      const shuffle = (arr) => {
        const a = [...arr];
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      };

      const speakStatus = (text) => {
        els.statusText.textContent = text;
      };

      const buildAudio = (src) => {
        const audio = new Audio();
        audio.src = src;
        audio.preload = "metadata";
        return audio;
      };

  // --- Rendering ---
      const renderCards = (items) => {
        els.cards.innerHTML = "";
        items.forEach((item, idx) => {
          const card = document.createElement("article");
          card.className = "card";
          card.setAttribute("role", "group");
          card.setAttribute("aria-label", `Sound card ${idx + 1}`);

          const playBtn = document.createElement("button");
          playBtn.className = "play";
          playBtn.setAttribute("aria-label", `Play sound ${item.word}`);
          playBtn.textContent = "â–¶";
          const audio = buildAudio(item.audio);
          playBtn.addEventListener("click", () => {
            audio.currentTime = 0;
            audio.play().catch(() => {});
          });

          const label = document.createElement("div");
          label.className = "label";
          label.innerHTML = `<span class="sr-only">Card ID:</span><code>${item.id}</code>`;
          label.style.display = "none";

          const drop = document.createElement("div");
          drop.className = "dropzone";
          drop.setAttribute("role", "button");
          drop.setAttribute("tabindex", "0");
          drop.setAttribute(
            "aria-label",
            `Drop matching word here for ${item.word} sound`,
          );
          drop.dataset.dropFor = item.id;
          drop.textContent = "---Drop or click here to add word----";

          // Drag-over / drop handlers
          drop.addEventListener("dragover", (e) => {
            e.preventDefault();
            drop.classList.add("filled");
          });
          drop.addEventListener("dragleave", () => {
            drop.classList.remove("filled");
          });
          drop.addEventListener("drop", (e) => {
            e.preventDefault();
            const tileId = e.dataTransfer.getData("text/plain");
            assignTileToDrop(tileId, drop);
          });

          // Keyboard/touch: tap card assigns selected tile
          drop.addEventListener("click", () => {
            if (state.selectedTileId)
              assignTileToDrop(state.selectedTileId, drop);
          });
          drop.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              if (state.selectedTileId)
                assignTileToDrop(state.selectedTileId, drop);
            }
          });

          card.appendChild(playBtn);
          card.appendChild(label);
          card.appendChild(drop);
          els.cards.appendChild(card);
        });
      };

      const renderTiles = (items) => {
        els.tiles.innerHTML = "";
        const order = shuffle(items.map((i) => ({ id: i.id, word: i.word })));
        order.forEach(({ id, word }) => {
          const tile = document.createElement("div");
          tile.className = "tile";
          tile.textContent = word;
          if (t != 0 && tlang[t])
            tile.textContent +=
              " - " + Sanscript.t(word, "devanagari", tlang[t]);
          tile.setAttribute("draggable", "true");
          tile.setAttribute("role", "button");
          tile.setAttribute("tabindex", "0");
          tile.dataset.tileId = id;

          tile.addEventListener("dragstart", (e) => {
            tile.classList.add("dragging");
            e.dataTransfer.setData("text/plain", id);
          });
          tile.addEventListener("dragend", () =>
            tile.classList.remove("dragging"),
          );

          // Touch/keyboard selection
          tile.addEventListener("click", () => selectTile(tile));
          tile.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              selectTile(tile);
            }
          });

          els.tiles.appendChild(tile);
        });
      };

      const selectTile = (tile) => {
        // Toggle selection
        const id = tile.dataset.tileId;
        const already = state.selectedTileId === id;
        Array.from(document.querySelectorAll(".tile")).forEach((t) =>
          t.classList.remove("dragging"),
        );
        if (already) {
          state.selectedTileId = null;
          tile.classList.remove("dragging");
          speakStatus("Selection cleared.");
        } else {
          state.selectedTileId = id;
          tile.classList.add("dragging");
          speakStatus(`Selected: ${tile.textContent}. Tap a card to assign.`);
        }
      };

      const assignTileToDrop = (tileId, dropEl) => {
        const tile = document.querySelector(`.tile[data-tile-id="${tileId}"]`);
        if (!tile) return;
        const dropForId = dropEl.dataset.dropFor;

        // If this drop had a previous assignment, unassign that tile
        const prev = state.assigned.get(dropForId);
        if (prev && prev !== tileId) {
          const prevTile = document.querySelector(
            `.tile[data-tile-id="${prev}"]`,
          );
          if (prevTile) prevTile.classList.remove("assigned");
        }

        // Assign
        state.assigned.set(dropForId, tileId);
        dropEl.textContent = tile.textContent;
        dropEl.classList.add("filled");
        tile.classList.add("assigned");

        // Clear selection feedback
        Array.from(document.querySelectorAll(".dropzone")).forEach((d) =>
          d.classList.remove("incorrect", "correct"),
        );

        // Update score preview (without check)
        updateScorePreview();
        speakStatus(`Assigned "${tile.textContent}" to card ${dropForId}.`);
      };
      
      const updateScorePreview = () => {
        const { items, assigned } = state;
        let correct = 0;
        items.forEach((item) => {
          const a = assigned.get(item.id);
          if (a && a === item.id) correct++;
        });
        els.score.textContent = correct;
        els.total.textContent = items.length;
      };

  async function checkAnswers() {
    let correct = 0;
        state.items.forEach((item) => {
          const drop = document.querySelector(
            `.dropzone[data-drop-for="${item.id}"]`,
          );
          const assignedId = state.assigned.get(item.id);
          drop.classList.remove("incorrect", "correct");
          if (assignedId) {
            if (assignedId === item.id) {
              drop.classList.add("correct");
              correct++;
            } else {
              drop.classList.add("incorrect");
            }
          }
        });
        state.lastCheck = Date.now();
        els.score.textContent = correct;
        els.total.textContent = state.items.length;
        speakStatus(
          `You have ${correct} correct out of ${state.items.length}.`,
        );

    // âœ… Always submit (even if correct = 0)
    try {
      if (typeof window.reportScore !== "function") {
        alert("Score system not loaded. Check js/bp26-score.js path.");
        return;
      }
      console.log("Submitting score:", correct);
      await window.reportScore(correct);

      // âœ… Celebration ONLY after submit success
      bp26Celebrate({
        title: "Score Submitted âœ…",
        subtitle: `Great job! `,
        score: correct
      });

      //alert("Score submitted: " + correct);
    } catch (e) {
      console.error("Submit error:", e);
      alert("Firebase submit failed. Open Console (F12) and send the red error.");
    }
  }

  const resetAll = () => {
        state.assigned.clear();
        state.selectedTileId = null;
        Array.from(document.querySelectorAll(".dropzone")).forEach((d) => {
          d.textContent = "";
          d.classList.remove("filled", "incorrect", "correct");
        });
        Array.from(document.querySelectorAll(".tile")).forEach((t) => {
          t.classList.remove("assigned", "dragging");
        });
        els.score.textContent = "0";
        els.total.textContent = state.items.length;
        speakStatus("Reset. Try again!");
      };

  const shuffleAll = () => {
        // Re-render tiles in random order
        renderTiles(state.items);
        // Shuffle cards display order for extra variation
        const shuffledItems = shuffle(state.items);
        renderCards(shuffledItems);
        // Clear assignments
        state.assigned.clear();
        els.score.textContent = "0";
        els.total.textContent = state.items.length;
        speakStatus("Shuffled.");
      };

  const playAll = async () => {
        speakStatus("Playing all sounds in order...");
        for (const item of state.items) {
          const audio = buildAudio(item.audio);
          try {
            await audio.play();
          } catch (e) {}
          // Wait for ~1.2s or audio end (whichever is earlier)
          await new Promise((res) => {
            const timer = setTimeout(res, 1200);
            audio.addEventListener(
              "ended",
              () => {
                clearTimeout(timer);
                res();
              },
              { once: true },
            );
          });
        }
        speakStatus("Done playing all.");
      };

      const applyHintVisibility = () => {
        const show = document.getElementById("hintToggle").checked;
        Array.from(document.querySelectorAll(".card .label")).forEach((el) => {
          el.style.display = show ? "block" : "none";
        });
      };

      // --- Init ---
      const init = async () => {
        //      try {
        //        const res = await fetch('sounds.json');
        //        if (!res.ok) throw new Error('Failed to fetch sounds.json');
        //        const data = await res.json();

        document.addEventListener("DOMContentLoaded", function () {
          var lnk =
            "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6CFR_0gDsZl-lmwLFWmtdXMXYGVEHGJ8fvBu2_5wvbEl9L-4Yr0ugI0TFTTdvtLlMTRmLnCIJ5FBF/pub?gid=0&single=true&output=csv";
          Papa.parse(lnk, {
            download: true,
            header: true,
            complete: populateWlist,
          });
        });

        function populateWlist(fildat) {
          var wpp = 15; // words per page

          fullist = fildat.data;
          var openmojibase = "https://openmoji.org/data/color/svg/";

          var timer;

          const urlParams = new URLSearchParams(window.location.search);
          var o = urlParams.get("o");
          if (!o)
            // open mode - 1 is true - not flipped
            o = 0;
          var set = urlParams.get("s");
          if (!set || isNaN(set) || set >= fullist.length) set = 0;
          var image = [];
          var words = [];
          var aud = [];
          var imglnk = "";
          for (i = 0; i < wpp; i++) {
            words.push(fullist[set * wpp + i].padam);
            if (
              fullist[set * wpp + i]["Imaage link"].length == 4 ||
              fullist[set * wpp + i]["Imaage link"].length == 5
            )
              imglnk =
                openmojibase + fullist[set * wpp + i]["Imaage link"] + ".svg";
            else imglnk = fullist[set * wpp + i]["Imaage link"];
            aud.push(fullist[set * wpp + i].alnk);
            image.push(imglnk);
          }
          while (!words[words.length - 1]) {
            words.pop();
          }
          while (!image[image.length - 1]) {
            image.pop();
          }

          state.items = [];
          for (let i = 0; i < words.length; i++) {
            state.items.push({
              id: (i + 1).toString(),
              word: words[i],
              audio: aud[i],
            });
          }
          //state.items = data.items;
          els.appTitle.textContent = "Audio Match";
          renderCards(state.items);
          // below logic is for audio shuffle
          // const shuffledItems = shuffle(state.items);
          // renderCards(shuffledItems);
          renderTiles(state.items);
          els.total.textContent = state.items.length;
          speakStatus("Loaded. Drag words onto sound cards or tap to assign.");
        }
      };
      // --- Wire controls ---

      els.checkBtn.addEventListener("click", checkAnswers);
      els.resetBtn.addEventListener("click", resetAll);
      els.playAllBtn.addEventListener("click", playAll);

      // Start
      init();

</script>

<!-- âœ… module loads first, then init runs -->
<script type="module">
  import { bp26Init, reportScore } from "./js/bp26-score.js";

  // keep compatibility
  window.reportScore = reportScore;

  // init this game
  bp26Init({ game: "bp26-Game5" });
</script>
<!-- Auth Middleware-->
<script type="module" src="/auth/api/middleware.js"></script>
</body>
</html>
