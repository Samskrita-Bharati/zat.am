<!DOCTYPE html>
<html lang="en">
<head>
  <!-- NOTE THIS DOES NOT WORK WITH .htm ONLY .html -->
  <meta charset="utf-8" />
  <title>Audio Match â€“ Learn Words</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@sanskrit-coders/sanscript@1.1.0/sanscript.min.js"></script>

  <style>
    body { margin:0; font-family: system-ui, Arial, sans-serif; background:#f7f9fc; }
    header { padding:1rem; background:white; border-bottom:1px solid #ddd; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { padding:8px 14px; border-radius:8px; border:1px solid #ccc; cursor:pointer; }
    .accent { background:#16a34a; color:white; }
    .warn { background:#dc2626; color:white; }
    main { max-width:1100px; margin:auto; padding:1rem; }
    .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    .card { background:white; border-radius:10px; padding:12px; display:flex; align-items:center; gap:10px; }
    .play { border-radius:50%; width:42px; height:42px; }
    .dropzone { flex:1; border:2px dashed #ccc; padding:10px; border-radius:8px; min-height:28px; }
    .correct { border-color:#16a34a; }
    .incorrect { border-color:#dc2626; }
    .tiles { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .tile { background:#edf2f7; padding:6px 10px; border-radius:8px; border:1px solid #ccc; cursor:grab; user-select:none; }
    
    /* âœ… Celebration UI (inline - no external file) */
    #bp26CelebrateOverlay{
      position: fixed; inset: 0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.35);
      z-index: 10000;
      padding: 20px;
    }
    .bp26CelebrateBox{
      position: relative;
      width: min(460px, 92vw);
      background: #fff;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.25);
      text-align: center;
      font-family: system-ui, Arial, sans-serif;
    }
    .bp26Sparkles{
      font-size: 54px;
      line-height: 1.1;
      margin: 8px 0 6px;
      animation: bp26Pop 600ms ease-out both;
    }
    @keyframes bp26Pop{
      0%{ transform: scale(0.6); opacity: 0; }
      100%{ transform: scale(1); opacity: 1; }
    }
    .bp26Btn{
      margin-top: 12px; padding: 10px 14px;
      border-radius: 12px; border: 1px solid #ddd;
      background: #f9fafb; cursor: pointer;
    }
    .bp26Confetti{
      position: fixed;
      top: -12px;
      width: 10px; height: 10px;
      border-radius: 3px;
      z-index: 10001;
      opacity: .95;
      animation: bp26Fall 950ms linear forwards;
      pointer-events: none;
    }
    @keyframes bp26Fall{
      to{ transform: translateY(110vh) rotate(540deg); opacity: 0.9; }
    }
  </style>
</head>

<body>
<header>
  <h2 style="margin:0;">Audio Match</h2>
  <button id="checkBtn" class="accent">Check Answers</button>
  <button id="resetBtn" class="warn">Reset</button>
</header>

<main>
  <section class="grid" id="cards"></section>

  <h3>Word Bank</h3>
  <div class="tiles" id="tiles"></div>

  <p><b>Score:</b> <span id="score">0</span>/<span id="total">0</span></p>
</main>

<!-- âœ… Celebration overlay (inline) -->
<div id="bp26CelebrateOverlay">
  <div class="bp26CelebrateBox">
    <div class="bp26Sparkles">âœ¨ðŸŽ‰âœ¨</div>
    <div id="bp26CelebrateTitle" style="font-weight:700;font-size:18px;margin-bottom:6px;">
      Submitted âœ…
    </div>
    <div id="bp26CelebrateSub" style="font-size:14px;color:#374151;">
      Nice work!
    </div>
    <button id="bp26CelebrateClose" class="bp26Btn">Close</button>
  </div>
</div>

<script>
  /* -------------------------------
     Celebration (inline)
  -------------------------------- */
  function bp26Celebrate({ title="Submitted âœ…", subtitle="Nice work!", score=null } = {}) {
    const overlay = document.getElementById("bp26CelebrateOverlay");
    const t = document.getElementById("bp26CelebrateTitle");
    const s = document.getElementById("bp26CelebrateSub");

    t.textContent = title;
    s.textContent = score === null ? subtitle : `${subtitle}  Score: ${score} âœ¨`;

    overlay.style.display = "flex";
    bp26BurstConfetti(70);

    setTimeout(() => { overlay.style.display = "none"; }, 2200);
  }

  function bp26BurstConfetti(count=60) {
    for (let i = 0; i < count; i++) {
      const c = document.createElement("div");
      c.className = "bp26Confetti";
      c.style.left = Math.random() * 100 + "vw";
      c.style.width = (6 + Math.random() * 8) + "px";
      c.style.height = (6 + Math.random() * 8) + "px";
      c.style.background = `hsl(${Math.floor(Math.random() * 360)}, 90%, 60%)`;
      c.style.transform = `translateY(0) rotate(${Math.random() * 180}deg)`;
      c.style.animationDuration = (800 + Math.random() * 600) + "ms";
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 1600);
    }
  }

  // close handlers
  document.getElementById("bp26CelebrateClose").addEventListener("click", () => {
    document.getElementById("bp26CelebrateOverlay").style.display = "none";
  });
  document.getElementById("bp26CelebrateOverlay").addEventListener("click", (e) => {
    if (e.target.id === "bp26CelebrateOverlay") e.target.style.display = "none";
  });

  /* -------------------------------
     Game logic (UNCHANGED behavior)
  -------------------------------- */
  const state = { items: [], assigned: new Map() };
  const els = {
    cards: document.getElementById("cards"),
    tiles: document.getElementById("tiles"),
    score: document.getElementById("score"),
    total: document.getElementById("total"),
    checkBtn: document.getElementById("checkBtn"),
    resetBtn: document.getElementById("resetBtn")
  };

  function render(items) {
    els.cards.innerHTML = "";
    els.tiles.innerHTML = "";
    state.assigned.clear();

    items.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";

      const btn = document.createElement("button");
      btn.className = "play";
      btn.textContent = "â–¶";
      const audio = new Audio(item.audio);
      btn.onclick = () => { audio.currentTime = 0; audio.play(); };

      const drop = document.createElement("div");
      drop.className = "dropzone";
      drop.dataset.id = item.id;
      drop.textContent = "Drop word here";

      drop.ondragover = e => e.preventDefault();
      drop.ondrop = e => {
        e.preventDefault();
        const draggedId = e.dataTransfer.getData("text");
        assign(draggedId, drop);
      };

      card.append(btn, drop);
      els.cards.appendChild(card);

      const tile = document.createElement("div");
      tile.className = "tile";
      tile.textContent = item.word;
      tile.draggable = true;
      tile.dataset.id = item.id;
      tile.ondragstart = e => e.dataTransfer.setData("text", item.id);

      els.tiles.appendChild(tile);
    });

    els.total.textContent = items.length;
    els.score.textContent = "0";
  }

  function assign(id, drop) {
    const tile = document.querySelector(`.tile[data-id="${id}"]`);
    if (!tile) return;

    drop.textContent = tile.textContent;
    state.assigned.set(drop.dataset.id, id);
  }

  async function checkAnswers() {
    let correct = 0;

    state.items.forEach(item => {
      const drop = document.querySelector(`.dropzone[data-id="${item.id}"]`);
      drop.classList.remove("correct","incorrect");

      const chosen = state.assigned.get(item.id);

      if (chosen) {
        if (chosen === item.id) {
          drop.classList.add("correct");
          correct++;
        } else {
          drop.classList.add("incorrect");
        }
      } else {
        drop.classList.add("incorrect");
      }
    });

    els.score.textContent = correct;

    // âœ… Always submit (even if correct = 0)
    try {
      if (typeof window.reportScore !== "function") {
        alert("Score system not loaded. Check js/bp26-score.js path.");
        return;
      }
      console.log("Submitting score:", correct);
      await window.reportScore(correct);

      // âœ… Celebration ONLY after submit success
      bp26Celebrate({
        title: "Score Submitted âœ…",
        subtitle: `Great job! `,
        score: correct
      });

      //alert("Score submitted: " + correct);
    } catch (e) {
      console.error("Submit error:", e);
      alert("Firebase submit failed. Open Console (F12) and send the red error.");
    }
  }

  els.checkBtn.onclick = checkAnswers;
  els.resetBtn.onclick = () => location.reload();

  // LOAD WORDS (12)
  Papa.parse(
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6CFR_0gDsZl-lmwLFWmtdXMXYGVEHGJ8fvBu2_5wvbEl9L-4Yr0ugI0TFTTdvtLlMTRmLnCIJ5FBF/pub?gid=0&single=true&output=csv",
    {
      download: true,
      header: true,
      complete: (res) => {
        const rows = (res.data || []).filter(r => r && r.padam && r.alnk).slice(0, 12);
        state.items = rows.map((r, i) => ({
          id: String(i + 1),
          word: r.padam,
          audio: r.alnk
        }));
        render(state.items);
      }
    }
  );
</script>

<!-- âœ… module loads first, then init runs -->
<script type="module">
  import { bp26Init, reportScore } from "./js/bp26-score.js";

  // keep compatibility
  window.reportScore = reportScore;

  // init this game
  bp26Init({ game: "bp26-Game5" });
</script>
<!-- Auth Middleware-->
<script type="module" src="/auth/api/middleware.js"></script>
</body>
</html>
