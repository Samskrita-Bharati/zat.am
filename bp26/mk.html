<!DOCTYPE html>
<html lang="en">

<head>
  <!-- NOTE THIS DOES NOT WORK WITH .htm ONLY .html -->
  <!-- Get player's name from auth -->
  <script type="module">
    import { onAuthStateChanged } from "firebase/auth";
    import { getFirestore, doc, getDoc } from "firebase/firestore"; 
    import { auth, db } from "../auth/api/firebase-config.js";
    window.currentUser = null;
    onAuthStateChanged(auth, (user) => {
      window.currentUser = user
      if (user) {
        console.log(window.currentUser.displayName)
      } else {
        console.log("no user found")
      }
      
    });
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Memory क्रीडा</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@sanskrit-coders/sanscript@1.1.0/sanscript.min.js"></script>
  <link href="css/mmk.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>

  <style>
    /* Floating submit button + score badge */
    #submitScoreBtn {
      position: fixed;
      right: 20px;
      bottom: 20px;
      padding: 12px 16px;
      border: none;
      border-radius: 12px;
      background: #1f2937;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    #submitScoreBtn:disabled { opacity: 0.6; cursor: not-allowed; }

    #scoreBadge {
      position: fixed;
      left: 20px;
      bottom: 24px;
      padding: 10px 14px;
      border-radius: 12px;
      background: #ffffff;
      color: #111827;
      font-size: 14px;
      z-index: 9999;
      box-shadow: 0 10px 20px rgba(0,0,0,0.12);
      border: 1px solid #e5e7eb;
    }
  </style>
</head>

<body>
  <center>
    <font size="+18" color="blue"> Memory क्रीडा </font>
    <br>

    <p id="wm">
      Matches Done: <span id="nomd" style="color: green; font-size: 20px;">०</span>
      Wrong Moves: <span style="color: red; font-size: 20px;" id="nowt">०</span>
      <span style="margin-left:16px; font-weight:700;">Time: <span id="timeDisp">0</span>s</span>
    </p>

    <progress id="pr" max="15" value="0"></progress>

    <div id="mytable"></div>
  </center>

  <!-- Score badge + submit button -->
  <div id="scoreBadge">Score: <span id="scoreValue">0</span></div>
  <button id="submitScoreBtn">Submit Score (Game 2)</button>

  <script>
    // ---------------------------
    // Timer
    // ---------------------------
    var secs = 0;
    var timer = null;

    function tick() {
      secs++;
      const t = document.getElementById("timeDisp");
      if (t) t.textContent = String(secs);
    }

    // ✅ Submit only once (shared for button + auto submit)
    let scoreSubmitted = false;

    // will be set after game loads
    let currentScore = 0;

    function updateScoreUI() {
      const el = document.getElementById("scoreValue");
      if (el) el.textContent = String(currentScore);
    }

    async function submitScoreNow() {
      // ✅ allow submit even if score = 0
      if (scoreSubmitted) return;

      const btn = document.getElementById("submitScoreBtn");
      if (btn) {
        btn.disabled = true;
        btn.textContent = "Submitting...";
      }

      try {
        if (typeof window.reportScore !== "function") {
          alert("Score system not loaded. Check ./js/bp26-score.js path.");
          if (btn) {
            btn.disabled = false;
            btn.textContent = "Submit Score (Game 2)";
          }
          return;
        }

        await window.reportScore(currentScore);
        scoreSubmitted = true;

        if (btn) btn.textContent = `Submitted ✅ (Score: ${currentScore})`;
        console.log("✅ Game2 score submitted:", currentScore);
      } catch (e) {
        console.error("❌ submit score failed", e);
        alert("Submit failed. Open Console (F12) and send the red error.");

        if (btn) {
          btn.disabled = false;
          btn.textContent = "Submit Score (Game 2)";
        }
      }
    }

    document.getElementById("submitScoreBtn").addEventListener("click", submitScoreNow);

    // ---------------------------
    // Load CSV
    // ---------------------------
    document.addEventListener('DOMContentLoaded', function () {
      var lnk = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6CFR_0gDsZl-lmwLFWmtdXMXYGVEHGJ8fvBu2_5wvbEl9L-4Yr0ugI0TFTTdvtLlMTRmLnCIJ5FBF/pub?gid=0&single=true&output=csv";
      Papa.parse(lnk, {
        download: true,
        header: true,
        complete: populateWlist
      });
    });

    function populateWlist(fildat) {
      var wpp = 15; // words per page
      document.getElementById("pr").max = wpp;

      var tlang = [];
      tlang[1] = "itrans";
      tlang['gu'] = "gujarati";
      tlang['ka'] = "kannada";
      tlang['be'] = "bengali";
      tlang['ml'] = "malayalam";
      tlang['te'] = "telugu";
      tlang['ta'] = "tamil";

      var fullist = fildat.data || [];

      var openmojibase = "https://openmoji.org/data/color/svg/";
      var numberOfWrongTries = 0;
      var matchesdone = 0;
      var triesElement = document.getElementById("nowt");

      const urlParams = new URLSearchParams(window.location.search);

      var o = urlParams.get('o');
      if (!o) o = 0;

      var set = urlParams.get('s');
      if (!set || isNaN(set) || (set >= fullist.length)) set = 0;

      var image = [];
      var words = [];
      var imglnk = "";

      for (let i = 0; i < wpp; i++) {
        const row = fullist[(set * wpp) + i];
        if (!row) continue;

        words.push(row.padam);

        const imgVal = row["Imaage link"] || "";
        if (imgVal.length == 4 || imgVal.length == 5)
          imglnk = openmojibase + imgVal + ".svg";
        else
          imglnk = imgVal;

        image.push(imglnk);
      }

      while (words.length && !words[words.length - 1]) words.pop();
      while (image.length && !image[image.length - 1]) image.pop();

      var colors = ['tomato', 'aqua', 'blue', 'fuchsia', 'gray', 'green', 'lime', 'maroon', 'navy', 'olive', 'purple', 'red', 'silver', 'teal', 'yellow'];

      var l = urlParams.get('l');
      if (!l) l = 0;

      var t = urlParams.get('t');
      if (!t) t = 0;

      function restart() { location.reload(); }

      var rowLength = words.length / 3;
      var colLength = 6;
      var gamesize = rowLength * colLength;

      var height = 120;
      var width = 150;

      // Start timer only in play mode
      if (l != 1) {
        secs = 0;
        if (timer) clearInterval(timer);
        timer = setInterval(tick, 1000);
      }
      tick();

      // ---------------------------
      // Build Game Data
      // ---------------------------
      var waiting = { value: false };
      var D1Data = [];
      var D2Data = [];
      var count = 0;

      for (var x = 0; x < gamesize / 2; x++) {
        D1Data.push({ src: image[x], clicked: false });
        D1Data.push({ src: image[x], clicked: false, wrd: words[x] });
      }

      // Fill 2D data
      var rand = 0;
      for (var y = 0; y < rowLength; y++) {
        var temp = [];
        var x = 0;
        while (x < colLength) {
          if (l != 1) {
            rand = Math.floor(Math.random() * D1Data.length);
            temp.push(D1Data[rand]);
            temp[x].y = x;
            temp[x].x = y;
            D1Data.splice(rand, 1);
          } else {
            temp.push(D1Data[rand]);
            rand += 1;
          }
          x++;
        }
        D2Data.push(temp);
      }

      var clickedCards = [];
      var bg = 'bp26e.png';

      function genTable(rowLength, colLength, imageData2D) {
        var table = document.createElement("TABLE");
        table.id = 'tbl';
        var myTableDiv = document.getElementById("mytable");
        myTableDiv.innerHTML = ""; // clear old

        for (var i = 0; i < rowLength; i++) {
          var tr = document.createElement("TR");
          table.appendChild(tr);

          for (var j = 0; j < colLength; j++) {
            var td = document.createElement("TD");
            tr.appendChild(td);

            if (!imageData2D[i][j].wrd) {
              var img = document.createElement("img");
              img.src = (o != 1) ? bg : imageData2D[i][j].src;
              img.height = height;
              img.width = width;
              td.appendChild(img);
            } else {
              var p = document.createElement("p");
              p.className = "myp";
              p.innerHTML = imageData2D[i][j].wrd;
              if (t != 0 && tlang[t]) {
                p.innerHTML += " - " + Sanscript.t(imageData2D[i][j].wrd, 'devanagari', tlang[t]);
              }
              td.appendChild(p);
            }
          }
        }
        myTableDiv.appendChild(table);
      }

      genTable(rowLength, colLength, D2Data);

      // ✅ Score formula
      function computeScore() {
        const totalPairs = wpp;               // 15
        const base = totalPairs * 10;         // 150
        const penaltyWrong = numberOfWrongTries * 2;
        const penaltyTime = secs;            // seconds
        return Math.max(0, base - penaltyWrong - penaltyTime);
      }

      function refreshCurrentScore() {
        currentScore = computeScore(); // always keep updated
        updateScoreUI();
      }

      // initial score badge
      refreshCurrentScore();

      var clkfn = function () {
        var row = this.parentElement.parentElement.rowIndex;
        var column = this.parentElement.cellIndex;

        if (!D2Data[row][column].clicked && !waiting.value) {

          if (clickedCards.length == 0) {
            // first card
            if (this.tagName.toLowerCase() === "img") {
              this.src = D2Data[row][column].src;
              this.height = height;
              this.width = width;
            }

            D2Data[row][column].clicked = true;
            clickedCards.push(D2Data[row][column]);

            var d = document.getElementsByTagName("tr")[clickedCards[0].x];
            var r = d.getElementsByTagName("td")[clickedCards[0].y];
            r.style.border = "2px dashed red";

          } else {
            // second card - compare
            if (D2Data[row][column].src === clickedCards[0].src) {
              // MATCH
              var d = document.getElementsByTagName("tr")[clickedCards[0].x];
              var r = d.getElementsByTagName("td")[clickedCards[0].y];
              r.style.border = "3px solid " + colors[matchesdone];
              r.style.cursor = "no-drop";
              r.style.color = "blue";

              matchesdone++;
              r.innerHTML += "<br>☑️ " + Sanscript.t(String(matchesdone), 'iast', 'devanagari');
              document.getElementById("pr").value = matchesdone;

              document.getElementById("nomd").innerHTML = Sanscript.t(String(matchesdone), 'iast', 'devanagari');

              this.parentElement.style.border = "3px solid " + colors[matchesdone - 1];
              this.parentElement.style.cursor = "no-drop";
              this.style.color = "blue";
              this.innerHTML += "<br>✔️ " + Sanscript.t(String(matchesdone), 'iast', 'devanagari');

              if (this.tagName.toLowerCase() === "img") {
                this.src = D2Data[row][column].src;
              }

              D2Data[row][column].clicked = true;
              clickedCards = [];
              count += 2;

              refreshCurrentScore();

              // GAME COMPLETE
              if (count == gamesize) {
                if (timer) clearInterval(timer);

                refreshCurrentScore(); // final score

                // ✅ auto submit at end (still works, even if 0)
                submitScoreNow();

                window.alert(
                  "उत्तमम् ! You matched all " +
                  Sanscript.t(String(wpp), 'iast', 'devanagari') +
                  " in " + Sanscript.t(String(secs), 'iast', 'devanagari') +
                  " seconds while making " +
                  Sanscript.t(String(numberOfWrongTries), 'iast', 'devanagari') +
                  " wrong moves.\n\nFinal Score: " + currentScore
                );

                var ask = confirm("पुनः ? Press 'ok' to play again");
                if (ask) restart();
              }

            } else {
              // NOT A MATCH
              numberOfWrongTries += 1;
              triesElement.innerHTML = Sanscript.t(String(numberOfWrongTries), 'iast', 'devanagari');

              if (this.tagName.toLowerCase() === "img") {
                this.src = D2Data[row][column].src;
              }

              D2Data[row][column].clicked = true;
              waiting.value = true;

              var d = document.getElementsByTagName("tr")[clickedCards[0].x];
              var r = d.getElementsByTagName("td")[clickedCards[0].y];
              r.style.border = "1px solid blue";

              refreshCurrentScore();

              setTimeout(flipback, 700, row, column, this, clickedCards, waiting, D2Data);
            }
          }
        }
      };

      function flipback(row, column, This, clickedCards, waiting, D2Data) {
        if (This.tagName.toLowerCase() === "img") {
          This.src = bg;
        }
        document.getElementById('tbl')
          .rows[clickedCards[0].x]
          .cells[clickedCards[0].y]
          .firstElementChild.src = bg;

        clickedCards[0].clicked = false;
        D2Data[row][column].clicked = false;
        waiting.value = false;
        clickedCards.splice(0, 1);

        refreshCurrentScore();
      }

      if (l != 1) {
        var list = document.getElementsByTagName("img");
        for (var i = 0; i < list.length; i++) list[i].onclick = clkfn;

        var plist = document.getElementsByClassName("myp");
        for (var i = 0; i < plist.length; i++) plist[i].onclick = clkfn;
      }
    }
  </script>

  <script type="module">
    import "./js/bp26-score.js";
    // ✅ Save under bp26-Game2 (separate), and included in bp26 aggregate
    window.bp26Init({ game: "bp26-Game2", day: 2 });
  </script>
  <!-- Auth Middleware-->
  <script type="module" src="/auth/api/middleware.js"></script>
</body>
</html>
